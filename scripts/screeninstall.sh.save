#!/bin/bash
set -euo pipefail

# screeninstall.sh — Raybridge kiosk + dimmer setup for Raspberry Pi OS / Debian / Ubuntu
#
# What it does:
#  - Installs minimal GUI + LightDM + Chromium (correct package per distro)
#  - Sets LXDE autostart to launch Raybridge dashboard in kiosk mode
#  - Installs an idle-dimmer loop (dims after inactivity, restores on input)
#
# What it does NOT do:
#  - Install your LCD driver/overlay (model-specific). Do that first.
#
# Usage:
#   sudo USERNAME=rob ./screeninstall.sh
#
# Optional env overrides:
#   DASH_URL="http://127.0.0.1/rayhunter/"
#   IDLE_SECS=180
#   DIM_LEVEL=0.25
#   BRIGHT_LEVEL=1.0
#   USERNAME=rob

DASH_URL="${DASH_URL:-http://127.0.0.1/rayhunter/}"
IDLE_SECS="${IDLE_SECS:-180}"
DIM_LEVEL="${DIM_LEVEL:-0.25}"
BRIGHT_LEVEL="${BRIGHT_LEVEL:-1.0}"
USERNAME="${USERNAME:-pi}"

if [[ "$(id -u)" -ne 0 ]]; then
  echo "Run as root: sudo $0" >&2
  exit 1
fi

have_cmd() { command -v "$1" >/dev/null 2>&1; }

pick_chromium_cmd() {
  if have_cmd chromium; then
    echo chromium
    return 0
  fi
  if have_cmd chromium-browser; then
    echo chromium-browser
    return 0
  fi
  echo ""
  return 1
}

install_chromium_pkg() {
  # Try Debian/RPiOS first
  if apt-cache show chromium >/dev/null 2>&1; then
    apt install -y chromium
    return 0
  fi
  # Try Ubuntu-style package name
  if apt-cache show chromium-browser >/dev/null 2>&1; then
    apt install -y chromium-browser
    return 0
  fi
  return 1
}

echo "[+] Installing kiosk packages (GUI + LightDM + Chromium) ..."
apt update
apt install -y \
  xserver-xorg xinit \
  lightdm raspberrypi-ui-mods \
  xprintidle x11-xserver-utils

# Install a Chromium variant if not already present
CHROME_CMD="$(pick_chromium_cmd || true)"
if [[ -z "${CHROME_CMD}" ]]; then
  echo "[+] Chromium not found; installing appropriate package..."
  if ! install_chromium_pkg; then
    echo "ERROR: Could not find a Chromium package via apt (chromium or chromium-browser)." >&2
    echo "Try: sudo apt-cache search chromium | head" >&2
    exit 3
  fi
  CHROME_CMD="$(pick_chromium_cmd || true)"
fi

if [[ -z "${CHROME_CMD}" ]]; then
  echo "ERROR: Chromium installed but no executable found (chromium/chromium-browser)." >&2
  exit 4
fi

echo "[+] Using browser command: ${CHROME_CMD}"

echo "[+] Enabling display manager (lightdm) ..."
systemctl enable lightdm

echo "[+] Installing dimmer script ..."
install -d /usr/local/bin
cat >/usr/local/bin/raybridge-dimmer.sh <<'EOF'
#!/bin/bash
set -euo pipefail

# Dims the first connected display output after idle time, restores on activity.
IDLE_SECS="${IDLE_SECS:-180}"
DIM_LEVEL="${DIM_LEVEL:-0.25}"
BRIGHT_LEVEL="${BRIGHT_LEVEL:-1.0}"

export DISPLAY="${DISPLAY:-:0}"

OUTPUT="$(xrandr 2>/dev/null | awk '/ connected/{print $1; exit}')"
if [ -z "${OUTPUT:-}" ]; then
  exit 0
fi

dimmed="no"
while true; do
  idle_ms="$(xprintidle 2>/dev/null || echo 0)"
  idle_s=$((idle_ms / 1000))

  if [ "$idle_s" -ge "$IDLE_SECS" ]; then
    if [ "$dimmed" != "yes" ]; then
      xrandr --output "$OUTPUT" --brightness "$DIM_LEVEL" || true
      dimmed="yes"
    fi
  else
    if [ "$dimmed" = "yes" ]; then
      xrandr --output "$OUTPUT" --brightness "$BRIGHT_LEVEL" || true
      dimmed="no"
    fi
  fi

  sleep 2
done
EOF
chmod +x /usr/local/bin/raybridge-dimmer.sh

echo "[+] Writing LXDE autostart for user: $USERNAME"
HOME_DIR="$(getent passwd "$USERNAME" | cut -d: -f6)"
if [ -z "${HOME_DIR:-}" ] || [ ! -d "$HOME_DIR" ]; then
  echo "Could not determine home directory for user '$USERNAME'." >&2
  exit 2
fi

AUTOSTART_DIR="$HOME_DIR/.config/lxsession/LXDE-pi"
AUTOSTART_FILE="$AUTOSTART_DIR/autostart"

install -d -m 0755 "$AUTOSTART_DIR"
cat >"$AUTOSTART_FILE" <<EOF
@xset s off
@xset -dpms
@xset s noblank

@env IDLE_SECS=${IDLE_SECS} DIM_LEVEL=${DIM_LEVEL} BRIGHT_LEVEL=${BRIGHT_LEVEL} /usr/local/bin/raybridge-dimmer.sh

@${CHROME_CMD} \\
  --kiosk \\
  --incognito \\
  --disable-infobars \\
  --noerrdialogs \\
  --disable-session-crashed-bubble \\
  ${DASH_URL}
EOF

chown -R "$USERNAME:$USERNAME" "$HOME_DIR/.config"
chmod 0644 "$AUTOSTART_FILE"

echo
echo "[✓] Kiosk configured."
echo "    Browser:       ${CHROME_CMD}"
echo "    Dashboard URL: ${DASH_URL}"
echo "    Dim after:     ${IDLE_SECS}s  (DIM_LEVEL=${DIM_LEVEL}, BRIGHT_LEVEL=${BRIGHT_LEVEL})"
echo
echo "Next:"
echo "  1) Reboot: sudo reboot"
echo "  2) After boot, you should see the dashboard in kiosk mode."
echo
echo "Troubleshooting:"
echo "  - If screen is black: confirm LCD driver/overlay is installed."
echo "  - If kiosk doesn't start: check LightDM: sudo systemctl status lightdm --no-pager"
